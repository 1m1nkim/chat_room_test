<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>1대1 채팅 (메모리 저장)</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <script type="text/javascript">
        var stompClient = null;

        // [1] 채팅 기록 불러오기 (REST API)
        async function loadHistory() {
            var sender = document.getElementById("username").value;
            var receiver = document.getElementById("receiver").value;

            // REST API 호출
            let response = await fetch(`/api/chat/history?sender=${sender}&receiver=${receiver}`);
            if (response.ok) {
                let messages = await response.json();
                messages.forEach(function(msg) {
                    showMessage(msg);
                });
            } else {
                console.log("Failed to fetch history", response.status);
            }
        }

        // [2] 웹소켓 연결
        function connect() {
            // 먼저 기존 채팅 기록 불러오기
            loadHistory().then(() => {
                var socket = new SockJS('/ws-chat');
                stompClient = Stomp.over(socket);
                stompClient.connect({}, function(frame) {
                    console.log('Connected: ' + frame);

                    var username = document.getElementById("username").value;
                    // 개인 큐 구독
                    stompClient.subscribe('/user/' + username + '/queue/messages', function(message) {
                        showMessage(JSON.parse(message.body));
                    });
                });
            });
        }

        // 메시지 전송
        function sendMessage() {
            var sender = document.getElementById("username").value;
            var receiver = document.getElementById("receiver").value;
            var content = document.getElementById("content").value;

            var chatMessage = {
                sender: sender,
                receiver: receiver,
                content: content
            };

            stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));
        }

        // 메시지를 화면에 표시
        function showMessage(message) {
            var messages = document.getElementById("messages");
            var li = document.createElement("li");
            li.innerHTML = "<strong>" + message.sender + "</strong>: " + message.content;
            messages.appendChild(li);
        }
    </script>
</head>
<body>
<h2>1대1 채팅 클라이언트 (서버 메모리 저장)</h2>
<div>
    <label>Username:</label>
    <input type="text" id="username" placeholder="내 이름">
    <label>Receiver:</label>
    <input type="text" id="receiver" placeholder="상대방 이름">
    <button onclick="connect()">Connect & Load History</button>
</div>
<hr/>
<div>
    <label>Message:</label>
    <input type="text" id="content" placeholder="메시지를 입력하세요">
    <button onclick="sendMessage()">Send</button>
</div>
<ul id="messages"></ul>
</body>
</html>
